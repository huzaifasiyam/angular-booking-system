<section class="booking-page py-5 inner-section">
  <div class="container">
    <div class="row g-4">
      <h2 class="fw-bold mb-2">{{ 'BOOK A SERVICE' | translate }}</h2>
      <div class="col-md-3">
        <h4 class="mb-3">{{ 'CATEGORY' | translate }}</h4>
        <div class="category-list-container py-2 pe-2">
          <div class="list-group">
            <ng-container *ngIf="isCategoriesLoading; else categoriesLoaded">
              <div class="mb-2">
                <ngx-skeleton-loader
                  animation="pulse"
                  count="5"
                  [theme]="{ height: '30px' }"
                ></ngx-skeleton-loader>
              </div>
            </ng-container>

            <ng-template #categoriesLoaded>
              <div *ngFor="let category of categories" class="mb-2">
                <div
                  class="list-group-item list-group-item-action d-flex justify-content-between align-items-center cursor-pointer"
                  [class.active]="expandedCategory?.listId === category.listId"
                  (click)="toggleCategory(category)"
                >
                  <div class="d-flex align-items-center">
                    <i class="fa-solid fa-layer-group me-2"></i>
                    <span class="fw-semibold">{{ category.listValue }}</span>
                  </div>
                  <i
                    class="fa fa-chevron-right"
                    [class.fa-rotate-90]="expandedCategory?.listId === category.listId"
                  ></i>
                </div>

                <div
                  *ngIf="expandedCategory?.listId === category.listId"
                  class="sub-category-list-container ps-4"
                >
                  <div
                    *ngFor="let subCategory of category.subCategories"
                    class="list-group-item list-group-item-action cursor-pointer"
                    [class.active]="selectedSubCategory?.listId === subCategory.listId"
                    (click)="selectSubCategory(subCategory)"
                  >
                    {{ subCategory.listValue }}
                  </div>
                </div>
              </div>
            </ng-template>
          </div>
        </div>
      </div>

      <div class="col-md-5" id="service-section">
        <h4 class="mb-3">{{ 'CHOOSE A SERVICE' | translate }}</h4>

        <ng-container *ngIf="isServicesLoading; else servicesLoaded">
          <div class="list-group py-2 service-list-container pe-2 pe-lg-0">
            <ngx-skeleton-loader
              count="5"
              [theme]="{ height: '50px'}"
            ></ngx-skeleton-loader>
          </div>
        </ng-container>

        <ng-template #servicesLoaded>
          <div class="list-group py-2 service-list-container pe-2 pe-lg-0" *ngIf="selectedSubCategory">
            <div
              *ngFor="let service of servicesMap[selectedSubCategory.listId]"
              class="list-group-item d-flex justify-content-between align-items-center mb-2"
            >
              <div>
                <h6 class="fw-semibold mb-1">{{ service.listValue }}</h6>
                <p class="text-muted small mb-1">{{ service.description }}</p>
                <small class="text-muted">{{ service.duration }} {{ 'MINUTES' | translate }}</small>
              </div>
              <div class="d-flex align-items-center gap-2">
                <span class="fw-bold me-2">
                  {{ service.price | currency : 'USD' }}
                </span>
                <button
                  class="btn btn-sm btn-primary text-white"
                  (click)="openBookingModal(service)"
                >
                  <i class="fa fa-shopping-cart text-white"></i>
                </button>
              </div>
            </div>
          </div>

          <div *ngIf="!selectedSubCategory" class="text-center text-muted py-5">
            <p>{{ 'PLEASE SELECT A SUB-CATEGORY TO SEE SERVICES.' | translate }}</p>
          </div>
        </ng-template>
      </div>

      <div class="col-lg-4 d-none mt-0 d-lg-block">
        <div class="card shadow-sm p-4 sticky-top" style="top: 2rem">
          <h4 class="fw-bold mb-3">{{ 'YOUR CART' | translate }}</h4>
          <ng-container *ngIf="cart.length > 0; else emptyCart">
            <div class="list-group mb-3 cart-items-container py-1 border-0">
              <div
                *ngFor="let item of cart; let i = index"
                class="list-group-item"
              >
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <span class="fw-semibold">{{ item.service.listValue }}</span>
                  <div class="d-flex gap-2">
                    <i
                      class="fa fa-pencil-square-o cursor-pointer text-primary"
                      (click)="openBookingModal(item.service, item, i)"
                    ></i>
                    <i class="fa fa-trash-can cursor-pointer text-danger" (click)="removeFromCart(i)"></i>
                  </div>
                </div>
                <small class="d-block text-muted">
                  {{ item.artist.listValue }} | {{ item.date }} | {{ item.time }}
                </small>
                <div class="fw-bold mt-1">
                  {{ item.service.price | currency : 'USD' }}
                </div>
              </div>
            </div>
            <hr class="total-divider" />
            <div class="d-flex justify-content-between my-2">
              <span class="text-muted">{{ 'SUBTOTAL' | translate }}:</span>
              <span class="fw-bold">{{ subtotalAmount | currency : 'USD' }}</span>
            </div>
            <div class="d-flex justify-content-between my-2">
              <span class="text-muted">{{ 'TAX' | translate }} ({{ taxPercentage }}%):</span>
              <span class="fw-bold">{{ taxAmount | currency : 'USD' }}</span>
            </div>
            <hr class="total-divider" />
            <div class="d-flex justify-content-between fw-bold fs-5 mt-3 mb-4">
              <span>{{ 'TOTAL' | translate }}:</span>
              <span>{{ totalAmount | currency : 'USD' }}</span>
            </div>
            <button
              class="btn btn-success fw-semibold w-100"
              (click)="confirmBooking()"
            >
              {{ 'CONFIRM BOOKING' | translate }}
            </button>
          </ng-container>
          <ng-template #emptyCart>
            <div class="text-center text-muted py-5">
              <i class="fa fa-shopping-cart fs-1 mb-3"></i>
              <p>{{ 'YOUR CART IS EMPTY.' | translate }}</p>
            </div>
          </ng-template>
        </div>
      </div>
    </div>

    <div class="mobile-footer d-lg-none fixed-bottom bg-white shadow-lg p-3">
      <div class="d-flex justify-content-between align-items-center">
        <div class="fw-bold fs-5">
          {{ 'TOTAL' | translate }}: {{ totalAmount | currency : 'USD' }}
          ({{ cart.length }} {{ 'ITEMS' | translate }})
        </div>
        <button
          class="btn btn-success fw-semibold position-relative"
          [disabled]="cart.length === 0"
          data-bs-toggle="offcanvas"
          data-bs-target="#cartOffcanvas"
        >
          <i class="fa fa-shopping-cart"></i>
          <span
            *ngIf="cart.length > 0"
            class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
          >
            {{ cart.length }}
          </span>
        </button>
      </div>
    </div>

    <div class="offcanvas offcanvas-bottom h-85 mobile-cart" tabindex="-1" id="cartOffcanvas">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title">{{ 'YOUR CART' | translate }}</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
      </div>

      <div class="offcanvas-body">
        <ng-container *ngIf="cart.length > 0; else emptyCartMobile">
          <div class="list-group mb-3">
            <div *ngFor="let item of cart; let i = index" class="list-group-item">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="fw-semibold">{{ item.service.listValue }}</span>
                <div class="d-flex gap-2">
                  <i class="fa fa-pencil-square-o cursor-pointer text-primary" data-bs-dismiss="offcanvas"
                    (click)="openBookingModal(item.service, item, i)"></i>
                  <i class="fa fa-trash-can cursor-pointer text-danger" (click)="removeFromCart(i)"></i>
                </div>
              </div>
              <small class="d-block text-muted">
                {{ item.artist.listValue }} | {{ item.date }} | {{ item.time }}
              </small>
              <div class="fw-bold mt-1">{{ item.service.price | currency : 'USD' }}</div>
            </div>
          </div>
        </ng-container>
        <ng-template #emptyCartMobile>
          <div class="text-center text-muted py-5">
            <i class="fa fa-shopping-cart fs-1 mb-3"></i>
            <p>{{ 'YOUR CART IS EMPTY.' | translate }}</p>
          </div>
        </ng-template>
      </div>

      <div class="offcanvas-footer border-top p-3">
        <ng-container *ngIf="cart.length > 0">
          <div class="card p-3 my-2 total-summary-card">
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">{{ 'SUBTOTAL' | translate }}:</span>
              <span class="fw-bold">{{ subtotalAmount | currency : 'USD' }}</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">{{ 'TAX' | translate }} ({{ taxPercentage }}%):</span>
              <span class="fw-bold">{{ taxAmount | currency : 'USD' }}</span>
            </div>
            <div class="d-flex justify-content-between fw-bold fs-5 pt-2 border-top">
              <span>{{ 'TOTAL' | translate }}:</span>
              <span>{{ totalAmount | currency : 'USD' }}</span>
            </div>
          </div>
        </ng-container>
        <button
          class="btn btn-success fw-semibold w-100"
          [disabled]="cart.length === 0"
          (click)="confirmBooking()"
        >
          {{ 'CONFIRM BOOKING' | translate }}
        </button>
      </div>
    </div>
  </div>
</section>